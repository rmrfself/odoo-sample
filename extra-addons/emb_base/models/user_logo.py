# -*- coding: utf-8 -*-
# Part of Odoo. See LICENSE file for full copyright and licensing details.
from odoo import models, api, tools, fields
import json
from struct import pack
import ast
import uuid
import random
import hashlib

emb_color_map = '{"S0502":["239","200","16"],"S0505":["12","8","45"],"S0508":["249","230","202"],"S0520":["253","243","218"],"S0521":["178","108","41"],"S0525":["52","72","30"],"S0526":["17","54","117"],"S0538":["17","20","8"],"S0561":["225","0","0"],"S0562":["255","180","53"],"S0567":["243","160","1"],"S0568":["230","109","0"],"S0569":["22","95","40"],"S0571":["142","108",null],"S0572":["16","10","124"],"S0580":["53","105","61"],"S0619":["233","189","150"],"S0621":["205","57","0"],"S0630":["119","113","19"],"S0640":["111","81",null],"S0643":["38","35","69"],"S1001":["249","249","255"],"S1002":["249","249","244"],"S1005":["0","0","0"],"S1011":["183","169","172"],"S1015":["225","175","154"],"S1016":["236","150","140"],"S1017":["239","223","189"],"S1019":["236","160","130"],"S1020":["240","130","120"],"S1021":["235","102","2"],"S1022":["255","247","213"],"S1023":["255","230","105"],"S1024":["255","184","0"],"S1025":["215","128","0"],"S1028":["190","195","225"],"S1029":["160","195","235"],"S1030":["166","162","198"],"S1031":["223","190","200"],"S1032":["230","140","235"],"S1033":["216","100","150"],"S1034":["198","50","60"],"S1035":["121","0","0"],"S1037":["249","0","0"],"S1039":["235","0","0"],"S1040":["135","115","117"],"S1041":["140","127","131"],"S1042":["50","30","80"],"S1043":["25","5","37"],"S1044":["29","6","47"],"S1045":["195","239","191"],"S1046":["46","131","89"],"S1047":["166","194","132"],"S1049":["66","160","33"],"S1051":["30","100","25"],"S1054":["238","190","174"],"S1055":["235","188","128"],"S1056":["175","91","0"],"S1057":["100","39","2"],"S1058":["102","53","0"],"S1059":["83","6","1"],"S1061":["255","247","185"],"S1063":["240","248","236"],"S1064":["230","180","170"],"S1065":["255","145","0"],"S1066":["255","241","128"],"S1067":["255","255","133"],"S1068":["243","219","217"],"S1070":["246","206","105"],"S1071":["249","249","234"],"S1074":["214","213","232"],"S1076":["90","90","139"],"S1077":["190","205","200"],"S1078":["255","102","0"],"S1079":["23","85","35"],"S1080":["220","130","160"],"S1081":["240","110","120"],"S1082":["247","227","187"],"S1083":["255","193","0"],"S1085":["226","207","199"],"S1086":["249","249","224"],"S1090":["22","98","95"],"S1094":["38","191","202"],"S1095":["16","209","189"],"S1096":["15","105","120"],"S1100":["194","211","125"],"S1101":["9","133","49"],"S1103":["2","20","15"],"S1104":["165","175","104"],"S1108":["250","164","164"],"S1109":["220","100","150"],"S1111":["252","203","223"],"S1112":["70","1","110"],"S1113":["240","200","180"],"S1115":["240","185","185"],"S1117":["245","169","160"],"S1119":["180","110","117"],"S1120":["240","214","210"],"S1121":["250","185","203"],"S1122":["130","40","142"],"S1124":["255","236","0"],"S1126":["220","140","23"],"S1127":["250","236","198"],"S1128":["195","148","113"],"S1129":["106","31","6"],"S1130":["85","22","2"],"S1131":["73","0","2"],"S1134":["80","125","170"],"S1135":["255","240","114"],"S1137":["255","190","0"],"S1143":["74","88","112"],"S1145":["180","225","235"],"S1147":["235","0","0"],"S1148":["255","189","189"],"S1149":["232","200","156"],"S1151":["226","226","235"],"S1154":["250","153","153"],"S1156":["99","99","39"],"S1158":["186","69","0"],"S1159":["211","157","0"],"S1162":["16","57","74"],"S1165":["223","229","235"],"S1166":["142","126","126"],"S1167":["255","210","38"],"S1168":["245","116","10"],"S1169":["156","0","0"],"S1170":["151","95","47"],"S1171":["8","24","14"],"S1172":["110","120","140"],"S1173":["89","89","29"],"S1174":["13","41","4"],"S1175":["21","45","4"],"S1176":["81","83","8"],"S1177":["137","152","18"],"S1179":["143","98","61"],"S1180":["165","137","115"],"S1181":["203","0","0"],"S1182":["2","1","20"],"S1183":["50","6","20"],"S1184":["255","102","0"],"S1185":["252","190","5"],"S1186":["91","0","0"],"S1187":["255","229","0"],"S1188":["255","0","75"],"S1189":["75","18","45"],"S1190":["160","70","86"],"S1191":["189","30","96"],"S1192":["30","130",null],"S1193":["230","175","210"],"S1194":["210","116","215"],"S1195":["55","1","80"],"S1196":["150","195","225"],"S1197":["34","15","52"],"S1198":["60","80","117"],"S1199":["42","20","63"],"S1200":["20","11","45"],"S1201":["100","139","190"],"S1202":["24","43","86"],"S1203":["174","184","195"],"S1204":["168","200","188"],"S1205":["110","144","165"],"S1206":["30","110","111"],"S1207":["128","163","136"],"S1208":["12","61","3"],"S1209":["189","209","99"],"S1210":["39","59","0"],"S1211":["149","164","144"],"S1212":["99","99","45"],"S1213":["185","160","150"],"S1214":["100","40","40"],"S1215":["80","10","30"],"S1216":["172","28","1"],"S1217":["151","31","1"],"S1218":["223","223","203"],"S1219":["152","136","140"],"S1220":["118","89","96"],"S1222":["209","219","255"],"S1223":["220","224","241"],"S1224":["240","160","185"],"S1225":["250","203","203"],"S1226":["87","54","158"],"S1227":["175","137","1"],"S1228":["150","170","139"],"S1229":["224","219","219"],"S1230":["11","65","51"],"S1231":["229","50","106"],"S1232":["25","50","7"],"S1233":["13","34","16"],"S1234":["60","27","31"],"S1235":["120","50","152"],"S1236":["234","228","228"],"S1237":["188","61","44"],"S1238":["255","131","0"],"S1239":["255","171","87"],"S1240":["116","88","108"],"S1241":["93","52","70"],"S1242":["84","58","141"],"S1243":["224","198","59"],"S1246":["255","0","0"],"S1247":["102","0","0"],"S1248":["210","230","240"],"S1249":["98","170","220"],"S1250":["39","92","112"],"S1251":["48","111","117"],"S1252":["9","161","168"],"S1253":["27","76","164"],"S1254":["230","185","245"],"S1255":["190","25","130"],"S1256":["235","130","150"],"S1257":["230","0","65"],"S1258":["240","196","160"],"S1259":["226","130","100"],"S1260":["221","171","0"],"S1262":["169","136","3"],"S1263":["179","0","0"],"S1264":["106","0","0"],"S1265":["155","107","44"],"S1266":["156","109","69"],"S1267":["134","76","49"],"S1268":["239","239","229"],"S1269":["172","135","131"],"S1270":["183","183","175"],"S1271":["60","79","49"],"S1272":["74","74","25"],"S1273":["54","54","31"],"S1274":["92","154","26"],"S1275":["224","230","200"],"S1276":["112","119","15"],"S1277":["2","118","2"],"S1278":["0","175","56"],"S1279":["147","209","108"],"S1280":["70","183","116"],"S1283":["72","61","89"],"S1284":["70","110","120"],"S1285":["19","79","69"],"S1286":["52","50","19"],"S1287":["65","85","69"],"S1288":["165","111",null],"S1289":["220","235","240"],"S1291":["114","116","131"],"S1292":["209","220","250"],"S1293":["68","35","93"],"S1294":["65","32","68"],"S1295":["130","135","140"],"S1296":["210","170","240"],"S1297":["115","90","100"],"S1298":["100","70","100"],"S1299":["65","20","70"],"S1300":["126","30","70"],"S1301":["50","0","70"],"S1302":["110","10","150"],"S1303":["250","95","127"],"S1304":["180","115","100"],"S1305":["174","198","187"],"S1306":["126","108","124"],"S1307":["219","100","120"],"S1309":["35","70",null],"S1311":["150","26","50"],"S1312":["132","0","0"],"S1313":["252","143","12"],"S1317":["255","0","0"],"S1321":["203","203","189"],"S1322":["129","137","1"],"S1325":["248","245","241"],"S1327":["213","199","195"],"S1328":["192","178","183"],"S1329":["171","160","168"],"S1331":["237","246","212"],"S1332":["134","129","5"],"S1333":["243","182","0"],"S1503":["52","150","105"],"S1508":["193","203","185"],"S1510":["122","179","29"],"S1511":["238","80","120"],"S1513":["0","122","103"],"S1515":["255","140","203"],"S1517":["1","79","58"],"S1533":["205","5","77"],"S1534":["52","125","203"],"S1535":["35","35","139"],"S1536":["8","23","5"],"S1543":["255","214","199"],"S1545":["156","100","132"],"S1549":["230","174","111"],"S1550":["108","142","135"],"S1551":["176","174",null],"S1552":["108","124","113"],"S1554":["140","116","140"],"S1558":["235","113","131"],"S1560":["224","248",null],"S1561":["181","140","199"],"S1644":["163","194","215"],"S1800":["231","144","2"],"S1801":["250","220","150"],"S1802":["255","200","150"],"S1803":["255","155","110"],"S1804":["55","90","115"],"S1805":["40","80","90"],"S1806":["160","185","195"],"S1807":["180","150","130"],"S1808":["210","175","155"],"S1809":["160","125","130"],"S1810":["100","80","85"],"S1811":["60","40","55"],"S1812":["110","45","90"],"S1813":["110","45","65"],"S1814":["175","75","105"],"S1815":["145","180","50"],"S1816":["215","245","140"],"S1817":["170","175","20"],"S1818":["200","245","140"],"S1819":["195","145","60"],"S1820":["195","140","115"],"S1821":["250","200","150"],"S1822":["150","90","55"],"S1823":["90","40",null],"S1824":["210","195","175"],"S1825":["95","150","25"],"S1826":["170","130","10"],"S1827":["255","100","60"],"S1828":["255","230","170"],"S1829":["240","235","165"],"S1830":["180","115","150"],"S1831":["145","225","45"],"S1832":["225","145","25"],"S1833":["210","95","0"],"S1834":["175","170","5"],"S1835":["110","130","5"],"S1836":["60","75","5"],"S1837":["115","90",null],"S1838":["205","170","125"],"S1839":["135","200","135"],"S0542":["255","255","0"],"S1261":["255","236","0"],"S1367":["255","180","0"],"S0836":["220","210","175"],"S0868":["235","210","120"],"S0622":["248","212","138"],"S1334":["167","138","5"],"S1244":["202","169","2"],"S1245":["178","142","0"],"S0688":["185","165","100"],"S1389":["195","185","150"],"S0610":["149","149","139"],"S1282":["146","149","3"],"S1609":["15","60","15"],"S0523":["231","144","2"],"S1320":["199","126","35"],"S0614":["139","30","1"],"S0535":["125","38","42"],"S1323":["71","2","0"],"S1324":["70","1","0"],"S0677":["255","110","0"],"S1393":["230","25","25"],"S1319":["239","0","0"],"S1315":["235","102","6"],"S1314":["240","110","12"],"S1401":["185","25","25"],"S0607":["150","60","70"],"S1310":["188","54","90"],"S1308":["154","44","80"],"S1036":["122","0","0"],"S0534":["120","20","60"],"S0670":["105","55","60"],"S1720":["140","205","175"],"S1711":["175","180",null],"S0861":["135","180",null],"S1290":["85","165",null],"S0817":["235","195",null],"S1281":["3","103","70"],"S0570":["55","140","55"],"S1718":["0","200","0"],"S0524":["34","3","39"],"S1598":["25","30","45"],"S1465":["225","225","225"],"S0501":["180","185","165"],"S1326":["238","227","225"],"S1351":["255","255","225"],"S1721":["160","145","130"],"S1330":["137","112","125"],"S1352":["40","40","40"],"S1366":["255","241","128"]}'

emb_color_dict = json.loads(emb_color_map)

class UserLogo(models.Model):
    _name = 'emb_base.user_logo'

    @api.one
    def _compute_uid(self):
        for record in self:
            uniq_num = str(uuid.uuid4().fields[-1])[:6]
            self.logo_uid = random.choice("LD-") + uniq_num

    @api.one
    @api.depends("logo_id", "emb_lines")
    def _compute_logo_key(self):
        for record in self:
            # Transfer the raw data into array
            # By shenfei, 2018/0421
            if self.emb_lines:
                key_secret = "%s" % self.logo_id.id + self.emb_lines
                print("  0000000 0000 00000")
                print(key_secret)
                hashlib_md5 = hashlib.md5()
                hashlib_md5.update(key_secret.decode("utf-8"))
                record.logo_key = hashlib_md5.hexdigest()

    @api.one
    def _get_docoration_service(self):
        # This field is for temporatory using fixed value
        self.decoration_service = "Embordery"

    @api.one
    @api.depends("emb_lines")
    def _compute_emb_line_colors(self):
        for record in self:
            # Transfer the raw data into array
            # By shenfei, 2018/0401
            raw_paths = ast.literal_eval(record.emb_lines)
            emb_color_objs = {}
            emb_color_list = []
            if raw_paths and len(raw_paths) > 0:
                emb_color_list = raw_paths.values()
                for hex_color in emb_color_list:
                    int_color_value = emb_color_dict[hex_color]
                    int_color = tuple(map(int, int_color_value))
                    rgb_color = '#' + pack("BBB", *int_color).encode('hex')
                    emb_color_objs[hex_color] = rgb_color
                #self.emb_colors = json.dumps(emb_color_objs)

    @api.one
    @api.depends("order_line_ids")
    def _compute_order_lines(self):
        for record in self:
            print("compute dummy function")

    # Relationship with order_line:
    # One product(color,size) + (*) logo('line colors') == one order_line
    # Order line ids
    order_line_ids = fields.Many2many('sale.order.line', 'sale_order_line_user_logo_rel',
                                      'user_logo_id', 'sale_order_line_id', string="Order Lines")

    # Decoration Service: Embroidery or others
    decoration_service = fields.Char(
        "Service", compute="_get_docoration_service", readonly=True)

    # Base logo information
    logo_id = fields.Many2one(
        'emb_base.res_logo', required=True, ondelete='cascade')

    # Compute logo UID cached field
    logo_uid = fields.Char('UID', compute="_compute_uid", store=True)

    # Logo key for searching quick
    logo_key = fields.Char('Key', compute="_compute_logo_key", store=True)

    # Description - Store extra infomation like stroke colors
    description = fields.Text('Description')

    # Decoration service id field
    cid = fields.Integer("Cid")

    # svg uid
    svgUid = fields.Integer("Svguid")

    # Postion data field
    # Format: {x: 10, y: 20, label: 'Top Left',human_label: ''}
    position_info = fields.Char("Postion")

    # Lines count, only for embroidery design, cached filed
    emb_lines_count = fields.Integer('Lines Count')

    # Embroidery Lines Data, only for embroidery design, cached filed
    emb_lines = fields.Char("Embroidery Lines Data")

    # emb_colors
    emb_line_colors = fields.Char("Color Types", compute="_compute_emb_line_colors")

    # order_line_data
    order_lines_broker = fields.Char(compute="_compute_order_lines")