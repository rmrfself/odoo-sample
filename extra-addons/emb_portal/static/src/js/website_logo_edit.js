var cc = '{"S0502":["239","200","16"],"S0505":["12","8","45"],"S0508":["249","230","202"],"S0520":["253","243","218"],"S0521":["178","108","41"],"S0525":["52","72","30"],"S0526":["17","54","117"],"S0538":["17","20","8"],"S0561":["225","0","0"],"S0562":["255","180","53"],"S0567":["243","160","1"],"S0568":["230","109","0"],"S0569":["22","95","40"],"S0571":["142","108",null],"S0572":["16","10","124"],"S0580":["53","105","61"],"S0619":["233","189","150"],"S0621":["205","57","0"],"S0630":["119","113","19"],"S0640":["111","81",null],"S0643":["38","35","69"],"S1001":["249","249","255"],"S1002":["249","249","244"],"S1005":["0","0","0"],"S1011":["183","169","172"],"S1015":["225","175","154"],"S1016":["236","150","140"],"S1017":["239","223","189"],"S1019":["236","160","130"],"S1020":["240","130","120"],"S1021":["235","102","2"],"S1022":["255","247","213"],"S1023":["255","230","105"],"S1024":["255","184","0"],"S1025":["215","128","0"],"S1028":["190","195","225"],"S1029":["160","195","235"],"S1030":["166","162","198"],"S1031":["223","190","200"],"S1032":["230","140","235"],"S1033":["216","100","150"],"S1034":["198","50","60"],"S1035":["121","0","0"],"S1037":["249","0","0"],"S1039":["235","0","0"],"S1040":["135","115","117"],"S1041":["140","127","131"],"S1042":["50","30","80"],"S1043":["25","5","37"],"S1044":["29","6","47"],"S1045":["195","239","191"],"S1046":["46","131","89"],"S1047":["166","194","132"],"S1049":["66","160","33"],"S1051":["30","100","25"],"S1054":["238","190","174"],"S1055":["235","188","128"],"S1056":["175","91","0"],"S1057":["100","39","2"],"S1058":["102","53","0"],"S1059":["83","6","1"],"S1061":["255","247","185"],"S1063":["240","248","236"],"S1064":["230","180","170"],"S1065":["255","145","0"],"S1066":["255","241","128"],"S1067":["255","255","133"],"S1068":["243","219","217"],"S1070":["246","206","105"],"S1071":["249","249","234"],"S1074":["214","213","232"],"S1076":["90","90","139"],"S1077":["190","205","200"],"S1078":["255","102","0"],"S1079":["23","85","35"],"S1080":["220","130","160"],"S1081":["240","110","120"],"S1082":["247","227","187"],"S1083":["255","193","0"],"S1085":["226","207","199"],"S1086":["249","249","224"],"S1090":["22","98","95"],"S1094":["38","191","202"],"S1095":["16","209","189"],"S1096":["15","105","120"],"S1100":["194","211","125"],"S1101":["9","133","49"],"S1103":["2","20","15"],"S1104":["165","175","104"],"S1108":["250","164","164"],"S1109":["220","100","150"],"S1111":["252","203","223"],"S1112":["70","1","110"],"S1113":["240","200","180"],"S1115":["240","185","185"],"S1117":["245","169","160"],"S1119":["180","110","117"],"S1120":["240","214","210"],"S1121":["250","185","203"],"S1122":["130","40","142"],"S1124":["255","236","0"],"S1126":["220","140","23"],"S1127":["250","236","198"],"S1128":["195","148","113"],"S1129":["106","31","6"],"S1130":["85","22","2"],"S1131":["73","0","2"],"S1134":["80","125","170"],"S1135":["255","240","114"],"S1137":["255","190","0"],"S1143":["74","88","112"],"S1145":["180","225","235"],"S1147":["235","0","0"],"S1148":["255","189","189"],"S1149":["232","200","156"],"S1151":["226","226","235"],"S1154":["250","153","153"],"S1156":["99","99","39"],"S1158":["186","69","0"],"S1159":["211","157","0"],"S1162":["16","57","74"],"S1165":["223","229","235"],"S1166":["142","126","126"],"S1167":["255","210","38"],"S1168":["245","116","10"],"S1169":["156","0","0"],"S1170":["151","95","47"],"S1171":["8","24","14"],"S1172":["110","120","140"],"S1173":["89","89","29"],"S1174":["13","41","4"],"S1175":["21","45","4"],"S1176":["81","83","8"],"S1177":["137","152","18"],"S1179":["143","98","61"],"S1180":["165","137","115"],"S1181":["203","0","0"],"S1182":["2","1","20"],"S1183":["50","6","20"],"S1184":["255","102","0"],"S1185":["252","190","5"],"S1186":["91","0","0"],"S1187":["255","229","0"],"S1188":["255","0","75"],"S1189":["75","18","45"],"S1190":["160","70","86"],"S1191":["189","30","96"],"S1192":["30","130",null],"S1193":["230","175","210"],"S1194":["210","116","215"],"S1195":["55","1","80"],"S1196":["150","195","225"],"S1197":["34","15","52"],"S1198":["60","80","117"],"S1199":["42","20","63"],"S1200":["20","11","45"],"S1201":["100","139","190"],"S1202":["24","43","86"],"S1203":["174","184","195"],"S1204":["168","200","188"],"S1205":["110","144","165"],"S1206":["30","110","111"],"S1207":["128","163","136"],"S1208":["12","61","3"],"S1209":["189","209","99"],"S1210":["39","59","0"],"S1211":["149","164","144"],"S1212":["99","99","45"],"S1213":["185","160","150"],"S1214":["100","40","40"],"S1215":["80","10","30"],"S1216":["172","28","1"],"S1217":["151","31","1"],"S1218":["223","223","203"],"S1219":["152","136","140"],"S1220":["118","89","96"],"S1222":["209","219","255"],"S1223":["220","224","241"],"S1224":["240","160","185"],"S1225":["250","203","203"],"S1226":["87","54","158"],"S1227":["175","137","1"],"S1228":["150","170","139"],"S1229":["224","219","219"],"S1230":["11","65","51"],"S1231":["229","50","106"],"S1232":["25","50","7"],"S1233":["13","34","16"],"S1234":["60","27","31"],"S1235":["120","50","152"],"S1236":["234","228","228"],"S1237":["188","61","44"],"S1238":["255","131","0"],"S1239":["255","171","87"],"S1240":["116","88","108"],"S1241":["93","52","70"],"S1242":["84","58","141"],"S1243":["224","198","59"],"S1246":["255","0","0"],"S1247":["102","0","0"],"S1248":["210","230","240"],"S1249":["98","170","220"],"S1250":["39","92","112"],"S1251":["48","111","117"],"S1252":["9","161","168"],"S1253":["27","76","164"],"S1254":["230","185","245"],"S1255":["190","25","130"],"S1256":["235","130","150"],"S1257":["230","0","65"],"S1258":["240","196","160"],"S1259":["226","130","100"],"S1260":["221","171","0"],"S1262":["169","136","3"],"S1263":["179","0","0"],"S1264":["106","0","0"],"S1265":["155","107","44"],"S1266":["156","109","69"],"S1267":["134","76","49"],"S1268":["239","239","229"],"S1269":["172","135","131"],"S1270":["183","183","175"],"S1271":["60","79","49"],"S1272":["74","74","25"],"S1273":["54","54","31"],"S1274":["92","154","26"],"S1275":["224","230","200"],"S1276":["112","119","15"],"S1277":["2","118","2"],"S1278":["0","175","56"],"S1279":["147","209","108"],"S1280":["70","183","116"],"S1283":["72","61","89"],"S1284":["70","110","120"],"S1285":["19","79","69"],"S1286":["52","50","19"],"S1287":["65","85","69"],"S1288":["165","111",null],"S1289":["220","235","240"],"S1291":["114","116","131"],"S1292":["209","220","250"],"S1293":["68","35","93"],"S1294":["65","32","68"],"S1295":["130","135","140"],"S1296":["210","170","240"],"S1297":["115","90","100"],"S1298":["100","70","100"],"S1299":["65","20","70"],"S1300":["126","30","70"],"S1301":["50","0","70"],"S1302":["110","10","150"],"S1303":["250","95","127"],"S1304":["180","115","100"],"S1305":["174","198","187"],"S1306":["126","108","124"],"S1307":["219","100","120"],"S1309":["35","70",null],"S1311":["150","26","50"],"S1312":["132","0","0"],"S1313":["252","143","12"],"S1317":["255","0","0"],"S1321":["203","203","189"],"S1322":["129","137","1"],"S1325":["248","245","241"],"S1327":["213","199","195"],"S1328":["192","178","183"],"S1329":["171","160","168"],"S1331":["237","246","212"],"S1332":["134","129","5"],"S1333":["243","182","0"],"S1503":["52","150","105"],"S1508":["193","203","185"],"S1510":["122","179","29"],"S1511":["238","80","120"],"S1513":["0","122","103"],"S1515":["255","140","203"],"S1517":["1","79","58"],"S1533":["205","5","77"],"S1534":["52","125","203"],"S1535":["35","35","139"],"S1536":["8","23","5"],"S1543":["255","214","199"],"S1545":["156","100","132"],"S1549":["230","174","111"],"S1550":["108","142","135"],"S1551":["176","174",null],"S1552":["108","124","113"],"S1554":["140","116","140"],"S1558":["235","113","131"],"S1560":["224","248",null],"S1561":["181","140","199"],"S1644":["163","194","215"],"S1800":["231","144","2"],"S1801":["250","220","150"],"S1802":["255","200","150"],"S1803":["255","155","110"],"S1804":["55","90","115"],"S1805":["40","80","90"],"S1806":["160","185","195"],"S1807":["180","150","130"],"S1808":["210","175","155"],"S1809":["160","125","130"],"S1810":["100","80","85"],"S1811":["60","40","55"],"S1812":["110","45","90"],"S1813":["110","45","65"],"S1814":["175","75","105"],"S1815":["145","180","50"],"S1816":["215","245","140"],"S1817":["170","175","20"],"S1818":["200","245","140"],"S1819":["195","145","60"],"S1820":["195","140","115"],"S1821":["250","200","150"],"S1822":["150","90","55"],"S1823":["90","40",null],"S1824":["210","195","175"],"S1825":["95","150","25"],"S1826":["170","130","10"],"S1827":["255","100","60"],"S1828":["255","230","170"],"S1829":["240","235","165"],"S1830":["180","115","150"],"S1831":["145","225","45"],"S1832":["225","145","25"],"S1833":["210","95","0"],"S1834":["175","170","5"],"S1835":["110","130","5"],"S1836":["60","75","5"],"S1837":["115","90",null],"S1838":["205","170","125"],"S1839":["135","200","135"],"S0542":["255","255","0"],"S1261":["255","236","0"],"S1367":["255","180","0"],"S0836":["220","210","175"],"S0868":["235","210","120"],"S0622":["248","212","138"],"S1334":["167","138","5"],"S1244":["202","169","2"],"S1245":["178","142","0"],"S0688":["185","165","100"],"S1389":["195","185","150"],"S0610":["149","149","139"],"S1282":["146","149","3"],"S1609":["15","60","15"],"S0523":["231","144","2"],"S1320":["199","126","35"],"S0614":["139","30","1"],"S0535":["125","38","42"],"S1323":["71","2","0"],"S1324":["70","1","0"],"S0677":["255","110","0"],"S1393":["230","25","25"],"S1319":["239","0","0"],"S1315":["235","102","6"],"S1314":["240","110","12"],"S1401":["185","25","25"],"S0607":["150","60","70"],"S1310":["188","54","90"],"S1308":["154","44","80"],"S1036":["122","0","0"],"S0534":["120","20","60"],"S0670":["105","55","60"],"S1720":["140","205","175"],"S1711":["175","180",null],"S0861":["135","180",null],"S1290":["85","165",null],"S0817":["235","195",null],"S1281":["3","103","70"],"S0570":["55","140","55"],"S1718":["0","200","0"],"S0524":["34","3","39"],"S1598":["25","30","45"],"S1465":["225","225","225"],"S0501":["180","185","165"],"S1326":["238","227","225"],"S1351":["255","255","225"],"S1721":["160","145","130"],"S1330":["137","112","125"],"S1352":["40","40","40"],"S1366":["255","241","128"]}';
var dd = JSON.parse(cc);

function debug(value) {
    console.log("Started at:" + new Date());
    console.log(" S: == == === === === === ==");
    console.log(value);
    console.log("E: == == === === === === ==");
    console.log("Ended at: " + new Date());
}

(function ($) {
    $.extend({      
        getQueryString: function (name) {           
            function parseParams() {
                var params = {},
                    e,
                    a = /\+/g,  // Regex for replacing addition symbol with a space
                    r = /([^&=]+)=?([^&]*)/g,
                    d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
                    q = window.location.search.substring(1);

                while (e = r.exec(q))
                    params[d(e[1])] = d(e[2]);

                return params;
            }

            if (!this.queryStringParams)
                this.queryStringParams = parseParams(); 

            return this.queryStringParams[name];
        }
    });
})(jQuery);

odoo.define('emb_portal.website_logo_edit', function (require) {
    'use strict';

    var ajax = require('web.ajax');
    var core = require('web.core');
    var Widget = require('web.Widget');
    var base = require('web_editor.base');
    var website = require('website.website');
    var Model = require('web.Model');

    var qweb = core.qweb;
    var _t = core._t;
    var ZeroClipboard = window.ZeroClipboard;

    var exports = {};

    // Fabric move with pan mode
    const STATE_IDLE = 'idle';
    const STATE_PANNING = 'panning';
    fabric.Canvas.prototype.toggleDragMode = function (dragMode) {
        // Remember the previous X and Y coordinates for delta calculations
        let lastClientX;
        let lastClientY;
        // Keep track of the state
        let state = STATE_IDLE;
        // We're entering dragmode
        if (dragMode) {
            // Discard any active object
            this.discardActiveObject();
            // Set the cursor to 'move'
            this.defaultCursor = 'move';
            // Loop over all objects and disable events / selectable. We remember its value in a temp variable stored on each object
            this.forEachObject(function (object) {
                object.prevEvented = object.evented;
                object.prevSelectable = object.selectable;
                object.evented = false;
                object.selectable = false;
            });
            // Remove selection ability on the canvas
            this.selection = false;
            // When MouseUp fires, we set the state to idle
            this.on('mouse:up', function (e) {
                state = STATE_IDLE;
            });
            // When MouseDown fires, we set the state to panning
            this.on('mouse:down', (e) => {
                state = STATE_PANNING;
                lastClientX = e.e.clientX;
                lastClientY = e.e.clientY;
            });
            // When the mouse moves, and we're panning (mouse down), we continue
            this.on('mouse:move', (e) => {
                if (state === STATE_PANNING && e && e.e) {
                    // let delta = new fabric.Point(e.e.movementX, e.e.movementY); // No Safari support for movementX and movementY
                    // For cross-browser compatibility, I had to manually keep track of the delta
                    // Calculate deltas
                    let deltaX = 0;
                    let deltaY = 0;
                    if (lastClientX) {
                        deltaX = e.e.clientX - lastClientX;
                    }
                    if (lastClientY) {
                        deltaY = e.e.clientY - lastClientY;
                    }
                    // Update the last X and Y values
                    lastClientX = e.e.clientX;
                    lastClientY = e.e.clientY;
                    let delta = new fabric.Point(deltaX, deltaY);
                    this.relativePan(delta);
                    this.trigger('moved');
                }
            });
        } else {
            // When we exit dragmode, we restore the previous values on all objects
            this.forEachObject(function (object) {
                object.evented = (object.prevEvented !== undefined) ? object.prevEvented : object.evented;
                object.selectable = (object.prevSelectable !== undefined) ? object.prevSelectable : object.selectable;
            });
            // Reset the cursor
            this.defaultCursor = 'default';
            // Remove the event listeners
            this.off('mouse:up');
            this.off('mouse:down');
            this.off('mouse:move');
            // Restore selection ability on the canvas
            this.selection = true;
        }
    };

    // Over by shei fei

    /**
     * Author: Shenfei
     * 创建左侧类型Bar
     */
    var ProductCatetoryList = Widget.extend({
        /**
         * 初始函数
         */
        init: function (logoWidget, garmentWidget) {
            this._super();
            this.categoryList = new Object;
            this.logoWidget = logoWidget;
            this.garmentWidget = garmentWidget;
        },
        /**
         * 加载远程Category数据
         */
        start: function () {
            var self = this;
            this.setProductTypes();
            this.setDecorationServices();
            this.setProductTypeEvents();
        },
        setProductTypeEvents: function () {
            var self = this;
            $("input[name='product_type']").change(function () {
                var productType = localStorage.getItem('productType');
                if (Boolean(this.checked) == true) {
                    // Save to local
                    if (productType == null) {
                        var tmp = {
                            'data': []
                        };
                        tmp['data'].push(this.value);
                        localStorage.setItem('productType', JSON.stringify(tmp));
                    } else {
                        var dTmp = JSON.parse(productType);
                        if (dTmp['data'].indexOf(this.value) == -1) {
                            dTmp['data'].push(this.value);
                            localStorage.setItem('productType', JSON.stringify(dTmp));
                        }
                    }
                    self.garmentWidget.insertGarmentRow(this.value);
                } else {
                    var ddTmp = JSON.parse(productType);
                    self.garmentWidget.removeGarmentRow(this.value);
                    var indexOf = ddTmp['data'].indexOf(this.value);
                    ddTmp['data'].splice(indexOf, 1);
                    if (ddTmp['data'].length < 1) {
                        localStorage.removeItem('productType');
                    } else {
                        localStorage.setItem('productType', JSON.stringify(ddTmp));
                    }
                }
            });
        },
        setDecorationServices: function () {
            var self = this;
            ajax.jsonRpc('/portal/get_decoration_services', 'call', {})
                .then(function (result) {
                    $('#category-bar').append(qweb.render('emb_portal.CategoryDecorationService', {
                        'decoration_services': result
                    }));
                    $("input[name='decoration_service']").filter('[value="1"]').attr('checked', true);
                    self.setServiceSurcharges(1);
                    $("input[name='decoration_service']").change(function () {
                        localStorage.setItem('decorationService', $(this).val());
                        if (this.value == 2) {
                            return false;
                        }
                        self.setServiceSurcharges(this.value);
                        self.logoWidget.filterlogoList(this.value);
                    });
                    // Set decoration services
                    var decorationSrv = localStorage.getItem('decorationService');
                    if (decorationSrv != null) {
                        $("input[name='decoration_service']").each(function () {
                            var value = this.value;
                            if (value == decorationSrv) {
                                $(this).attr("checked", true);
                            }
                        });
                    }
                })
                .fail(function () {
                    var message = _t("Unable to get recent links");
                    self.$el.append("<div class='alert alert-danger'>" + message + "</div>");
                });
        },
        setProductTypes: function () {
            var self = this;
            $('#category-bar').append(qweb.render('emb_portal.CategoryProductSource', {}));
            // Set product sources
            var productSource = localStorage.getItem('productSource');
            if (productSource != null) {
                $("input[name='product_source']").each(function () {
                    var value = this.value;
                    if (value == productSource) {
                        $(this).attr("checked", true);
                    }
                });
            }
            // Default events
            $("input[name='product_source']").on('change', function () {
                localStorage.setItem('productSource', $(this).val());
            });
            ajax.jsonRpc('/portal/get_product_types', 'call', {})
                .then(function (result) {
                    $('#category-bar').append(qweb.render('emb_portal.CategoryProductType', {
                        'product_types': result
                    }));
                    self.setProductTypeEvents();
                    // Set product types
                    var tmpProductTypes = localStorage.getItem('productType');
                    if (tmpProductTypes != null) {
                        var productTypes = JSON.parse(tmpProductTypes);
                        $("input[name='product_type']").each(function () {
                            if (productTypes['data'].indexOf(this.value) > -1) {
                                $(this).click();
                            }
                        });
                    } else {
                        $("#cb2").click();
                    }
                })
                .fail(function () {
                    var message = _t("Unable to get recent links");
                    self.$el.append("<div class='alert alert-danger'>" + message + "</div>");
                });
        },
        setServiceSurcharges: function (cid) {
            this.logoWidget.filterlogoList(cid);
            $('#service-sc-select').children().remove();
            ajax.jsonRpc('/portal/get_service_surcharges', 'call', {
                    'cid': cid
                })
                .then(function (result) {
                    var list = result;
                    for (var key in list) {
                        var item = list[key];
                        $('#service-sc-select').append("<option value='" + item.id + "'>" + item.display_name + "</option>")
                    }
                    // Set default values
                    var cachedSscData = localStorage.getItem('serviceSurcharges');
                    if (cachedSscData != null) {
                        $('#service-sc-select').selectpicker('val', cachedSscData);
                    }
                    var cachedSscQty = localStorage.getItem('serviceSurchargeQty');
                    if (cachedSscQty != null) {
                        $('#service-surcharge-qty').val(cachedSscQty);
                    }
                    $('#service-sc-select').selectpicker('refresh');
                })
                .fail(function () {
                    var message = _t("Unable to get recent links");
                    self.$el.append("<div class='alert alert-danger'>" + message + "</div>");
                });
        }
    });

    var LogoUploadDialog = Widget.extend({
        template: 'website.logo.upload',
        events: {
            'hidden.bs.modal': 'destroy',
            'click button.save': 'save',
            'click button[data-dismiss="modal"]': 'cancel',
            'change input#upload_logo_button': 'logo_upload',
            'change input#url': 'slide_url',
            'click .list-group-item': function (ev) {
                this.$('.list-group-item').removeClass('active');
                $(ev.target).closest('li').addClass('active');
            }
        },
        init: function (el) {
            this._super(el);
            this.file = {};
        },
        start: function () {
            this.$el.modal({
                backdrop: 'static'
            });
            this.set_category_id();
        },
        /**
        Wrapper for select2 load data from server at once and store it.

        @param {String} Placeholder for element.
        @param {bool}  true for multiple selection box, false for single selection
        @param {Function} Function to fetch data from remote location should return $.deferred object
        resolved data should be array of object with id and name. eg. [{'id': id, 'name': 'text'}, ...]
        @returns {Object} select2 wrapper object
        */
        select2_wrapper: function (tag, multi, fetch_fnc) {
            return {
                width: '100%',
                placeholder: tag,
                allowClear: true,
                formatNoMatches: false,
                multiple: multi,
                selection_data: false,
                fetch_rpc_fnc: fetch_fnc,
                formatSelection: function (data) {
                    if (data.tag) {
                        data.text = data.tag;
                    }
                    return data.text;
                },
                createSearchChoice: function (term, data) {
                    var added_tags = $(this.opts.element).select2('data');
                    if (_.filter(_.union(added_tags, data), function (tag) {
                            return tag.text.toLowerCase().localeCompare(term.toLowerCase()) === 0;
                        }).length === 0) {
                        return {
                            id: _.uniqueId('tag_'),
                            create: true,
                            tag: term,
                            text: _.str.sprintf(_t("Create new tag '%s'"), term),
                        };
                    }
                },
                fill_data: function (query, data) {
                    var that = this,
                        tags = {
                            results: []
                        };
                    _.each(data, function (obj) {
                        if (that.matcher(query.term, obj.name)) {
                            tags.results.push({
                                id: obj.id,
                                text: obj.name
                            });
                        }
                    });
                    query.callback(tags);
                },
                query: function (query) {
                    var that = this;
                    // fetch data only once and store it
                    if (!this.selection_data) {
                        this.fetch_rpc_fnc().then(function (data) {
                            that.fill_data(query, data);
                            that.selection_data = data;
                        });
                    } else {
                        this.fill_data(query, this.selection_data);
                    }
                }
            };
        },
        // Category management from select2
        set_category_id: function () {
            var self = this;
            $('#category_id').select2({
                width: '100%',
                allowClear: true,
                formatNoMatches: false,
                multiple: false,
                selection_data: false,
                data: [{
                        id: 0,
                        text: 'Tajima Dst File'
                    },
                    {
                        id: 1,
                        text: 'Adobe Illustrator File'
                    }
                ]
            });
        },
        reset_file: function () {
            var control = this.$('#upload');
            control.replaceWith(control = control.clone(true));
            this.file.name = false;
        },
        get_category_id: function () {
            var value = $('#category_id').select2('data');
            if (value && value.create) {
                return [0, {
                    'name': value.text
                }];
            }
            return [value ? value.id : null];
        },
        // Values and save
        get_value: function () {
            var canvas = this.$('#data_canvas')[0],
                values = {
                    'file_name': this.$('#file_name').val(),
                    'image_width': this.$('#image_width').val(),
                    'image_height': this.$('#image_height').val(),
                    'size_unit': this.$('input[name="size_unit"]').val(),
                    'category_id': this.get_category_id()
                };
            if (/(.*?)\.(dst|ai)$/.test(this.file.file_name)) {
                _.extend(values, {
                    'image': this.file.data
                });
            }
            return values;
        },
        display_alert: function (message) {
            this.$('.alert-warning').remove();
            $('<div class="alert alert-warning" role="alert">' + message + '</div>').insertBefore(this.$('form'));
        },
        logo_upload: function (ev) {
            var self = this,
                file = ev.target.files[0],
                is_image = /(.*?)\.(dst|ai)$/.test(file.name),
                loaded = false;
            this.file.file_name = file.name;
            this.file.type = file.type;
            this.$('.alert-warning').remove();
            var BinaryReader = new FileReader();
            // file read as DataURL
            BinaryReader.readAsDataURL(file);
            BinaryReader.onloadend = function (upload) {
                var buffer = upload.target.result;
                if (is_image) {
                    self.$("#logo-image").attr("src", buffer);
                }
                buffer = buffer.split(',')[1];
                self.file.data = buffer;
            };
        },
        validate: function () {
            this.$('.form-group').removeClass('has-error');
            if (!this.$('#file_name').val()) {
                this.$('#file_name').closest('.form-group').addClass('has-error');
                return false;
            }
            if (!this.$('#image_width').val()) {
                this.$('#image_width').closest('.form-group').addClass('has-error');
                return false;
            }
            return true;
        },
        save: function (ev) {
            var self = this;
            if (this.validate()) {
                var values = this.get_value();
                this.$('.oe_slides_upload_loading').show();
                this.$('.modal-footer, .modal-body').hide();
                var urlPart;
                if (/(.*?)\.(dst)$/.test(this.file.file_name.toLowerCase())) {
                    urlPart = 'dst';
                }
                if (/(.*?)\.(ai)$/.test(this.file.file_name.toLowerCase())) {
                    urlPart = 'ai';
                }
                ajax.jsonRpc("/portal/upload_logo/" + urlPart, 'call', values).then(function (data) {
                    if (data.error) {
                        self.display_alert(data.error);
                        self.$('.oe_slides_upload_loading').hide();
                        self.$('.modal-footer, .modal-body').show();
                    } else {
                        window.location = data.url;
                    }
                });
            }
        },
        cancel: function () {
            this.trigger("cancel");
        }
    });

    /**
     * 4. Logo upload popup dialog
     */
    var LogoUpload = Widget.extend({
        init: function (cartManager) {
            this._super();
            this.logoList = null;
            this.lightSlider = null;
            this.cartManager = cartManager;
        },
        start: function () {
            var self = this;
            $('#op-bar').append(qweb.render('emb_portal.LogoUpload'));
            ajax.jsonRpc('/portal/logo_list', 'call', {})
                .then(function (result) {
                    self.logoList = result;
                    var cid = $("input[name='decoration_service']:checked").val();
                    if (cid == undefined || cid == null) {
                        cid = 1;
                    }
                    //self.filterlogoList(parseInt(cid));
                })
                .fail(function () {
                    var message = _t("Unable to get recent links");
                    self.$el.append("<div class='alert alert-danger'>" + message + "</div>");
                });
            $("#logo-upload-button").on("click", function (event) {
                var logoDialog = new LogoUploadDialog(this).appendTo(document.body);
                return false;
            });
            $("#logo-delete-button").on("click", function (event) {
                self.removeLogoFromList();
                return false;
            });
            $("#logo-type-select").editableSelect();
            $('.selectpicker').selectpicker({
                size: 4,
                iconBase: 'fa',
                tickIcon: 'fa-check'
            });
        },
        removeLogoFromList: function() {
            debug('hello, remove delete logo');
        },
        filterlogoList: function (sid) {
            var aiList = [];
            var dstList = [];
            debug(this.logoList);
            for (var key in this.logoList) {
                var img = this.logoList[key];
                if (img.category_id == '1') {
                    aiList.push(img);
                } 
                if (img.category_id == '0') {
                    dstList.push(img);
                }
            }
            // If the file belongs to DST
            if (sid == 1) {
                this.setLogoList(sid, dstList);
            }
            if (sid == 2) {
                this.setLogoList(sid, []);
            }
            if (sid > 2) {
                this.setLogoList(sid, aiList);
            }
        },
        setLogoList: function (cid, list) {
            var self = this;
            if (this.lightSlider != null) {
                this.lightSlider.destroy();
                $("#lightSlider").html("");
            }
            for (var key in list) {
                var img = list[key];
                var imgId = img.id;
                var imgName = img.file_name;
                var categoryId = img.category_id;
                var imgSrc = "/emb_portal/res_logo/image/" + imgId;
                var liEle = $('<li>');
                if (categoryId == 0) {
                    liEle.addClass("lside-dst");
                }
                if (categoryId == 1) {
                    liEle.addClass("lside-ai");
                }
                this.setReslogoImage(liEle, imgSrc);
                liEle.css("width", "80px").css("height", "80px").css("margin-right", "20px").css("z-index", 100);
                liEle.attr("id", img.id);
                liEle.attr("datatype", categoryId);
                liEle.attr("data-id", imgId);
                liEle.attr("draggable", "true");
                liEle.on("dragstart", this.startDrag);
                // Load Surcharges
                liEle.on("click", function (event) {
                    event.stopPropagation();
                    $(this).siblings().removeClass("current");
                    $(this).addClass("current");
                    $(this).children(".fa").remove();
                    $(this).append('<span class="fa fa-pencil-square-o"></span>');
                });
                $("#lightSlider").append(liEle);
            }
            this.lightSlider = $("#lightSlider").lightSlider();
            $("#lightSlider li:first").click();
        },
        startDrag: function (event) {
            localStorage.setItem('drag-logo-id',event.target.id);
            localStorage.setItem('drag-logo-type',$(event.target).attr('datatype'));
        },
        setReslogoImage: function (el, imgSrc) {
            $.get(imgSrc, function (data) {
                el.html($(new XMLSerializer().serializeToString(data.documentElement)).removeAttr("width").removeAttr("height"));
            });
        },
        showUploadDialog: function () {

        }
    });


    var GarmentUploadDialog = Widget.extend({
        template: 'website.garment.upload',
        events: {
            'hidden.bs.modal': 'destroy',
            'click button.save': 'save',
            'click button[data-dismiss="modal"]': 'cancel',
            'change input#upload_garment_button': 'garment_upload',
            'click .list-group-item': function (ev) {
                this.$('.list-group-item').removeClass('active');
                $(ev.target).closest('li').addClass('active');
            }
        },
        init: function (el) {
            this._super(el);
            this.file = {};
        },
        start: function () {
            this.$el.modal({
                backdrop: 'static'
            });
            this.set_category_id();
            $("#custom_garment_color").spectrum({
                showPaletteOnly: true,
                togglePaletteOnly: true,
                togglePaletteMoreText: 'more',
                togglePaletteLessText: 'less',
                hideAfterPaletteSelect: true,
                preferredFormat: "hex",
                color: 'blanchedalmond',
                showInput: true,
                showAlpha: true,
                palette: [
                    ["#000", "#444", "#666", "#999", "#ccc", "#eee", "#f3f3f3", "#fff"],
                    ["#f00", "#f90", "#ff0", "#0f0", "#0ff", "#00f", "#90f", "#f0f"],
                    ["#f4cccc", "#fce5cd", "#fff2cc", "#d9ead3", "#d0e0e3", "#cfe2f3", "#d9d2e9", "#ead1dc"],
                    ["#ea9999", "#f9cb9c", "#ffe599", "#b6d7a8", "#a2c4c9", "#9fc5e8", "#b4a7d6", "#d5a6bd"],
                    ["#e06666", "#f6b26b", "#ffd966", "#93c47d", "#76a5af", "#6fa8dc", "#8e7cc3", "#c27ba0"],
                    ["#c00", "#e69138", "#f1c232", "#6aa84f", "#45818e", "#3d85c6", "#674ea7", "#a64d79"],
                    ["#900", "#b45f06", "#bf9000", "#38761d", "#134f5c", "#0b5394", "#351c75", "#741b47"],
                    ["#600", "#783f04", "#7f6000", "#274e13", "#0c343d", "#073763", "#20124d", "#4c1130"]
                ],
                change: function (color) {
                    var colorBlock = $('<span>').css("width", "40px").css("height", "40px").css("background", color.toHexString());
                    colorBlock.css("display", "inline-block").css("margin", "0 6px");
                    var inputNode = $("<input>").attr("name", "colors[]").attr("type", "hidden").val(color.toHexString());
                    colorBlock.append(inputNode);
                    $("#garment_colors").show().append(colorBlock);
                    colorBlock.on("click", function () {
                        $(this).remove();
                    })
                }
            });
            $("#garment_colors").find("a").click(function () {
                $(this).siblings().remove();
                $(this).parent().hide();
            });
        },
        /**
        Wrapper for select2 load data from server at once and store it.

        @param {String} Placeholder for element.
        @param {bool}  true for multiple selection box, false for single selection
        @param {Function} Function to fetch data from remote location should return $.deferred object
        resolved data should be array of object with id and name. eg. [{'id': id, 'name': 'text'}, ...]
        @returns {Object} select2 wrapper object
        */
        select2_wrapper: function (tag, multi, fetch_fnc) {
            return {
                width: '100%',
                placeholder: tag,
                allowClear: true,
                formatNoMatches: false,
                multiple: multi,
                selection_data: false,
                fetch_rpc_fnc: fetch_fnc,
                formatSelection: function (data) {
                    if (data.tag) {
                        data.text = data.tag;
                    }
                    return data.text;
                },
                createSearchChoice: function (term, data) {
                    var added_tags = $(this.opts.element).select2('data');
                    if (_.filter(_.union(added_tags, data), function (tag) {
                            return tag.text.toLowerCase().localeCompare(term.toLowerCase()) === 0;
                        }).length === 0) {
                        return {
                            id: _.uniqueId('tag_'),
                            create: true,
                            tag: term,
                            text: _.str.sprintf(_t("Create new tag '%s'"), term),
                        };
                    }
                },
                fill_data: function (query, data) {
                    var that = this,
                        tags = {
                            results: []
                        };
                    _.each(data, function (obj) {
                        if (that.matcher(query.term, obj.name)) {
                            tags.results.push({
                                id: obj.id,
                                text: obj.name
                            });
                        }
                    });
                    query.callback(tags);
                },
                query: function (query) {
                    var that = this;
                    // fetch data only once and store it
                    if (!this.selection_data) {
                        this.fetch_rpc_fnc().then(function (data) {
                            that.fill_data(query, data);
                            that.selection_data = data;
                        });
                    } else {
                        this.fill_data(query, this.selection_data);
                    }
                }
            };
        },
        // Category management from select2
        set_category_id: function () {
            var self = this;
            $('#category_id').select2(this.select2_wrapper(_t('Category'), false,
                function () {
                    return ajax.jsonRpc("/web/dataset/call_kw", 'call', {
                        model: 'product.public.category',
                        method: 'search_read',
                        args: [],
                        kwargs: {
                            fields: ['name'],
                            context: base.get_context(),
                            domain: [],
                        }
                    });
                }));
        },
        reset_file: function () {
            var control = this.$('#upload');
            control.replaceWith(control = control.clone(true));
            this.file.name = false;
        },
        get_category_id: function () {
            var value = $('#category_id').select2('data');
            if (value && value.create) {
                return [0, {
                    'name': value.text
                }];
            }
            return [value ? value.id : null];
        },
        // Values and save
        get_value: function () {
            var canvas = this.$('#data_canvas')[0],
                values = {
                    'colors': this.$("input[name^='colors[]']").map(function () {
                        return $(this).val();
                    }).get(),
                    'product_size': this.$('#product_size').val(),
                    'category_id': this.get_category_id()
                };
            if (/^image\/.*/.test(this.file.type)) {
                _.extend(values, {
                    'image': this.file.data
                });
            }
            return values;
        },
        display_alert: function (message) {
            this.$('.alert-warning').remove();
            $('<div class="alert alert-warning" role="alert">' + message + '</div>').insertBefore(this.$('form'));
        },
        garment_upload: function (ev) {
            var self = this,
                file = ev.target.files[0],
                is_image = /^image\/.*/.test(file.type),
                loaded = false;
            this.file.file_name = file.name;
            this.file.type = file.type;

            this.$('.alert-warning').remove();
            var BinaryReader = new FileReader();
            // file read as DataURL
            BinaryReader.readAsDataURL(file);
            BinaryReader.onloadend = function (upload) {
                var buffer = upload.target.result;
                if (is_image) {
                    self.$("#garment-image").attr("src", buffer);
                }
                buffer = buffer.split(',')[1];
                self.file.data = buffer;
            };
        },
        validate: function () {
            this.$('.form-group').removeClass('has-error');
            if (!this.$('#upload_garment_button').val()) {
                this.$('#upload_garment_button').closest('.form-group').addClass('has-error');
                return false;
            }
            return true;
        },
        save: function (ev) {
            var self = this;
            if (this.validate()) {
                var values = this.get_value();
                this.$('.oe_slides_upload_loading').show();
                this.$('.modal-footer, .modal-body').hide();
                ajax.jsonRpc("/portal/upload_product", 'call', values).then(function (data) {
                    if (data.error) {
                        self.display_alert(data.error);
                        self.$('.oe_slides_upload_loading').hide();
                        self.$('.modal-footer, .modal-body').show();
                    } else {
                        window.location = data.url;
                    }
                });
            } else {
                console.log("product upload validation error");
            }
        },
        cancel: function () {
            this.trigger("cancel");
        }
    });

    /**
     * Created by zhang qing hua
     */
    var GarmentListManager = Widget.extend({
        init: function (logoEditor, cartManager) {
            this._super();
            this.garments = {};
            this.logoEditor = logoEditor;
            this.cartManager = cartManager;
        },
        talbeRowIndex: 0,
        garments: new Object(),
        start: function () {
            var self = this;
            $('#op-bar').append(qweb.render('emb_portal.GarmentUpload'));
            $("#garment-upload-btn").click(function () {
                var garmentDialog = new GarmentUploadDialog(this).appendTo(document.body);
                return false;
            });
            $("#garment-type-select").editableSelect();
            $('.selectpicker').selectpicker({
                size: 4,
                iconBase: 'fa',
                tickIcon: 'fa-check'
            });
        },
        insertGarmentRow: function (id) {
            var self = this;
            ajax.jsonRpc('/portal/product_list', 'call', {
                    category_id: id
                })
                .then(function (result) {
                    self.setGarments(result);
                    self.addGarmentCells(id, result);
                })
                .fail(function () {
                    var message = _t("Unable to get recent links");
                    self.$el.append("<div class='alert alert-danger'>" + message + "</div>");
                });
        },
        setGarments: function (result) {
            if (result.length < 1) {
                return false;
            }
            var cid = result[0]['public_categ_ids'][0];
            this.garments[cid] = result.slice();
        },
        removeGarmentRow: function (id) {
            $("#garment-row-" + id).effect("highlight", {
                color: '#ff0000'
            }, 3000);
            $('#garmentTable').find("#garment-row-" + id).remove();
        },
        addGarmentCells: function (id, data) {
            var self = this;
            var categoryId = id;
            var garmentRow = $("<tr id='garment-row-" + categoryId + "'>");
            var cbCell = $("<td>");
            garmentRow.append(cbCell.append("<input type='checkbox' value='" + id + "' id='garment-item-" + id + "' name='garment-item' />"));
            for (var item in data) {
                var gm = data[item];
                var imgSrc = "/website/image/product.template/" + gm.id + "/image/40x40";
                var garmentImage = $("<img>").attr("src", imgSrc);
                garmentImage.click(function () {
                    self.setLogoEditor(id, item);
                });
                var imgCell = $("<td>").append(garmentImage);
                garmentRow.append(imgCell);
            }
            $("#garmentTable").append(garmentRow);
            $('input[id="garment-item-' + id + '"]').click(function () {
                $('input[name="garment-item"]').prop('checked', false);
                self.setLogoEditor(id, 0);
                $(this).prop('checked', true);
            });
            $("#garment-item-2").click();
        },
        setColorPalette: function (garments, index) {
            var self = this;
            var g = garments[index];
            var colorStr = g.colors;
            if (colorStr) {
                var colorData = colorStr.split(",");
                if (colorData.length > 0) {
                    $("#colorPalette").html("");
                    for (var k in colorData) {
                        var color = colorData[k];
                        var p = $("<span>");
                        p.css("display", "inline-block").css("margin-right", "10px");
                        p.css("width", "30px").css("height", "30px").css("background", color);
                        p.attr("data-color", color);
                        $("#colorPalette").append(p);
                    }
                    $("#colorPalette").find("span").click(function () {
                        self.logoEditor.setLogoEditorBg($(this).attr("data-color"));
                    })
                }
            }
        },
        getGarmentsByCid: function (id) {
            return this.garments[id] == undefined ? [] : this.garments[id];
        },
        setLogoEditor: function (id, index = 0) {
            var allSelectedGm = $("input[name=garment-item]:checked");
            var g = this.getGarmentsByCid(id);
            if (allSelectedGm.length > 1) {
                console.log("selected one above garments.");
            }
            if (g != undefined) {
                var cachedCid = localStorage.getItem('cid');
                var cachedPid = localStorage.getItem("productId");
                if (cachedCid != null && cachedCid == id) {
                    if (cachedPid != null) {
                        for (var i in g) {
                            var tmp = g[i];
                            if (tmp.id == cachedPid) {
                                index = i;
                                break;
                            }
                        }
                    }
                }
                this.logoEditor.showLogoEditor(g, index);
            }
            this.setColorPalette(g, index);
        }
    });

    var LogoEditor = Widget.extend({
        init: function (cart, logoUpload) {
            this._super();
            var self = this;
            this.logo_canvas = new fabric.Canvas('logo-canvas', {
                selection: false,
                //preserveObjectStacking: true
                cacheobects: false,
                width: 580,
                height: 620
            });
            this.logo_canvas.selectionColor = 'rgba(0,255,0,0.3)';
            this.logo_index = 0;
            this.setUpCanvasZoom();
            this.cartManager = cart;
            this.logoManager = logoUpload;
            this.xAxis = null;
            this.yAxis = null;
            this.cartManager.setCanvas(this.logo_canvas);
        },
        start: function () {
            var self = this;
            //or you register with key/value pairs
            this.logo_canvas.on({
                'object:moving': self.onMovingHandler.bind(this),
                'object:modified': self.onModifiedHandler.bind(this),
                'object:added': self.onAddedHandler.bind(this),
                'object:removed': self.onRemovedHandler.bind(this),
                'object:rotating': self.onRetatingHandler.bind(this),
                'object:scaling': self.onScalingHandler.bind(this),
            });
            var xPoints = [0, 0, this.logo_canvas.width, 0];
            this.xAxis = new fabric.Line(xPoints, {
                strokeWidth: 1,
                fill: 'red',
                stroke: 'grey',
                originX: 'center',
                originY: 'center',
            });
            this.xAxis.selectable = false;
            this.logo_canvas.add(this.xAxis);
            this.xAxis.opacity = 0;
            var yPoints = [0, 0, 0, this.logo_canvas.height];
            this.yAxis = new fabric.Line(yPoints, {
                strokeWidth: 1,
                fill: 'red',
                stroke: 'grey',
                originX: 'center',
                originY: 'center',
            });
            this.yAxis.selectable = false;
            this.logo_canvas.add(this.yAxis);
            this.yAxis.opacity = 0;
            this.loadCachedLogos();
        },
        loadCachedLogos: function () {
            var cachedLogosData = localStorage.getItem('logos');
            if (cachedLogosData == null) {
                return false;
            }
            var logos = JSON.parse(cachedLogosData);
            if ($.isEmptyObject(logos)) {
                return false;
            }
            for (var key in logos) {
                var cachedLogo = logos[key];
                this.restoreLogoFromCache(cachedLogo);
            }
        },
        restoreLogoFromCache: function (cachedLogo) {
            var self = this;
            debug(cachedLogo);
            var resourceId = cachedLogo['resourceId'];
            // Load remote product colors
            ajax.jsonRpc('/portal/get_logo', 'call', {
                    'logo_id': resourceId
                })
                .then(function (result) {
                    // Show all colors
                    self.addLogoFromCache(cachedLogo, result.data);
                })
                .fail(function () {
                    var message = _t("Unable to get recent links");
                    self.$el.append("<div class='alert alert-danger'>" + message + "</div>");
                });
        },
        addLogoFromCache: function (logoData, imageData) {
            if (imageData == null) {
                return false;
            }
            var self = this;
            var logoType = logoData['type'];
            var logoId = logoData['resourceId'];
            var pLeft = logoData['left'];
            var pTop = logoData['top'];
            var svgUid = logoData['svgUid'];
            var colorInfoData = logoData['paths'] || {};
            var cid = logoData['cid'];
            debug(logoData);
            // AI file need to save to remote side.
            var paths = fabric.loadSVGFromString(imageData, function (objects, options) {
                if (logoType == 0) {
                    objects.map(function (item, index) {
                        item.id = 'logo-' + self.logo_index + "-" + index;
                        item.class = "logo-stroke-path";
                        item.svgUid = index;
                        var strokeColor = colorInfoData[index];
                        if (strokeColor == null || strokeColor == undefined) {
                            item.stroke = [0, 0, 0];
                        } else {
                            var strokeColorArr = dd[strokeColor].map(function (item) {
                                return parseInt(item);
                            });
                            item.stroke = 'rgb(' + strokeColorArr[0] + ',' + strokeColorArr[1] + ',' + strokeColorArr[2] + ')';
                            self.cartManager.updateLogoStroke(svgUid, item.svgUid, logoType, strokeColor);
                        }
                        item.strokeData = colorInfoData[index];
                        item.dataType = logoType;
                    });
                }
                if (logoType == 1) {
                    objects.map(function (item, index) {
                        item.id = 'logo-' + self.logo_index + "-" + index;
                        item.class = "logo-stroke-path";
                        item.svgUid = index;
                        item.fill = dd[colorInfoData[index]] || [0, 0, 0];
                        item.fillData = colorInfoData[index];
                        item.dataType = logoType;
                    });
                }
                var obj = fabric.util.groupSVGElements(objects, options);
                obj.lockScalingX = true;
                obj.lockScalingY = true;
                obj.inner_paths = [];
                obj.gType = logoType;
                obj.svgUid = svgUid;
                obj.resourceId = logoId;
                objects.map(function (item, index) {
                    obj.inner_paths.push(item);
                });
                //obj.subTargetCheck = true;
                //obj.selectable = true;
                obj.scaleToHeight(self.logo_canvas.height / 3)
                    .set({
                        left: pLeft,
                        top: pTop
                    }).center()
                    .setCoords();
                self.logo_canvas.add(obj).renderAll();
                self.showLogoLayers(objects);
                obj.on("selected", function (event) {
                    var act = self.logo_canvas.getActiveObject();
                    self.showLogoLayers(act.inner_paths);
                });
                // Add this logo into cartManager
                self.cartManager.addLogo(obj.svgUid, cid, logoId, logoType);
                self.cartManager.updateLogoPosition(obj.svgUid, obj.left, obj.top);
            });
            var canvas = self.logo_canvas;
            window.fabric.util.addListener(canvas.upperCanvasEl, 'dblclick', function (event) {
                self.removeLogo();
            });
        },
        onMovingHandler: function (event) {
            var canvasLeft = this.logo_canvas.viewportTransform[4];
            var canvasTop = this.logo_canvas.viewportTransform[5];
            var logoH = (event.target.height * event.target.scaleY) / 2 + event.target.top;
            this.xAxis.opacity = 1;
            this.xAxis.set("y1", logoH);
            this.xAxis.set("y2", logoH);
            this.xAxis.set("x1", 0 - canvasLeft);
            this.xAxis.set("x2", this.logo_canvas.width - canvasLeft);
            var logoW = (event.target.width * event.target.scaleX) / 2 + event.target.left;
            this.yAxis.opacity = 1;
            this.yAxis.set("x1", logoW);
            this.yAxis.set("x2", logoW);
            this.yAxis.set("y1", 0 - canvasTop);
            this.yAxis.set("y2", this.logo_canvas.height - canvasTop);
        },
        onModifiedHandler: function (event) {
            var activeObject = event.target;
            var svgUid = activeObject.svgUid;
            var left = activeObject.left;
            var top = activeObject.top;
            this.cartManager.updateLogoPosition(svgUid, left, top);
        },
        onAddedHandler: function (event) {
            var activeObject = event.target;
            var svgUid = activeObject.svgUid;
            if (activeObject.inner_paths != undefined) {
                var pathsCount = activeObject.inner_paths.length;
                this.cartManager.setLogoPathsCount(svgUid, pathsCount);
            }
        },
        onRemovedHandler: function (event) {
            var activeObject = event.target;
            var svgUid = activeObject.svgUid;
            this.cartManager.removeLogo(svgUid);
        },
        onRetatingHandler: function (event) {
            console.log(event);
        },
        onScalingHandler: function (event) {
            console.log(event);
        },
        setUpCanvasZoom: function () {
            var self = this;
            var parentContainer = $("#logo-editor");
            var zoomParentCon = $("<div>").attr("id", "zoom-bar");
            zoomParentCon.html("<input id='logo-zoomer' data-slider-id='ex1Slider' type='text' data-slider-min='1' data-slider-max='2' data-slider-step='0.1' data-slider-value='1.1'/>");
            parentContainer.append(zoomParentCon);
            $('#logo-zoomer').slider({
                precision: 2,
                orientation: 'vertical',
                formatter: function (value) {
                    return 'Zoom By: ' + value;
                }
            });
            var canvas = this.logo_canvas;
            var originZoom = canvas.getZoom();
            $("#logo-zoomer").on("slide", function (slideEvt) {
                var zoom = slideEvt.value;
                canvas.setZoom(originZoom * zoom);
                var viewportTransform = canvas.viewportTransform;
                self.cartManager.setCanvasViewportTransform(viewportTransform);
            });
            var moveSwitch = $("<div>").addClass("pan-move-bar");
            moveSwitch.html('<label class="checkbox-inline"><input id="canvas-drag-switch" type="checkbox" value="1">Move Mode</label>');
            parentContainer.append(moveSwitch);
            $("#canvas-drag-switch").change(function (event) {
                if ($(this).is(':checked')) {
                    canvas.toggleDragMode(true);
                } else {
                    canvas.toggleDragMode(false);
                }
            });
        },
        showLogoEditor: function (garments, index = 0, withDefault = false) {
            var parent = this;
            var imgId = garments[index].id;
            var categoryId = garments[index].public_categ_ids[0];
            var canvas = this.logo_canvas;
            // Set default values
            var cachedPid = localStorage.getItem("productId");
            var cachedCid = localStorage.getItem("cid");
            var cachedColor = localStorage.getItem("productColor");
            if (cachedColor != null && cachedPid == imgId) {
                this.logo_canvas.backgroundColor = cachedColor;
            } else {
                this.logo_canvas.backgroundColor = 'white';
                canvas.setBackgroundImage("/website/image/product.template/" + imgId + "/image/500x500", canvas.renderAll.bind(canvas), {
                    left: 50,
                    top: 50,
                    originX: 'left',
                    originY: 'top'
                });
            }
            $("#logo-editor").css("border-radius", "8px");
            $("#logo-editor").css("background-repeat", "no-repeat");
            $("#logo-editor").css("min-height", "500px").css("width", "582px").css("border", "1px solid #DDD");
            $("#logo-editor").unbind("drop");
            $("#logo-editor").unbind("dragover");
            $("#logo-editor").on("drop", this.onDropLogo.bind(this));
            $("#logo-editor").on("dragover", this.allowDropLogo);
            $("#grouped-garments").html("");
            var groupedImages = $("#grouped-garments").find("a");
            if (groupedImages.length == 0) {
                this.addSmallImages(garments);
            }
            $(".pan-move-bar").show("slow");
            this.logo_canvas.renderAll();
            // Set the garment to card
            this.setColorPalette(garments, index);
            this.setProductSizes(garments, index);
            this.cartManager.setProductId(categoryId, imgId);
        },
        addSmallImages: function (garments) {
            var self = this;
            var groupedGarments = $("#grouped-garments");
            groupedGarments.html("");
            var productIds = [];
            for (var key in garments) {
                var g = garments[key];
                var imageContainer = $("<a>");
                imageContainer.attr("data-index", key);
                if (key == 0) {
                    imageContainer.addClass("current");
                }
                imageContainer.on("click", function (event) {
                    // Clear cached color
                    localStorage.removeItem("productColor");
                    var index = $(this).attr("data-index");
                    self.showLogoEditor(garments, index);
                    $(this).siblings().removeClass("current");
                    $(this).addClass("current");
                });
                var img = new Image();
                img.src = "/website/image/product.template/" + g.id + "/image/40x40";
                imageContainer.append(img);
                groupedGarments.append(imageContainer);
            }
        },
        setProductSizes: function (garments, index) {
            var self = this;
            var g = garments[index];
            // Load remote product sizes
            ajax.jsonRpc('/portal/get_product_sizes', 'call', {
                    'product_id': g.id
                })
                .then(function (result) {
                    var sizeList = result;
                    var newSizeList = sizeList.slice();
                    if (sizeList.length > 0) {
                        $("#product-sizes-table").html("");
                        self.cartManager.setProductSizes(newSizeList);
                        while (sizeList.length > 0) {
                            var sizeItems = sizeList.splice(0, 3);
                            var trEle = $("<tr>");
                            for (var key in sizeItems) {
                                var sizeItem = sizeItems[key];
                                var label = $("<label>").text(sizeItem.name);
                                var sizeInput = $("<input>").attr("type", "text").attr("id", "size-" + sizeItem.name.toLowerCase() + "-count").attr("value", 0).attr("style", "width: 50px;text-align:center;color:gray;");
                                sizeInput.on("blur", function () {
                                    if (isNaN(this.value)) {
                                        this.value = 0;
                                    }
                                    this.value = Math.abs(this.value);
                                    self.cartManager.updateProductSizes();
                                });
                                var tdEle = $("<td>").append(label).append(sizeInput);
                                trEle.append(tdEle);
                            }
                            $("#product-sizes-table").append(trEle);
                        }
                        // Set default vlaues
                        var cachedSizes = localStorage.getItem("productSizes");
                        var cachedPid = localStorage.getItem("productId");
                        if (cachedSizes != null && cachedPid == g.id) {
                            var sizeData = JSON.parse(cachedSizes);
                            for (var key in sizeData) {
                                $("#size-" + key + "-count").val(sizeData[key]);
                            }
                        }
                    } else {
                        $("#product-sizes-table").html("<tr><td>No size meature found.</td></tr>");
                    }
                })
                .fail(function () {
                    var message = _t("Unable to get recent links");
                    self.$el.append("<div class='alert alert-danger'>" + message + "</div>");
                });
        },
        setColorPalette: function (garments, index) {
            var self = this;
            var g = garments[index];
            // Load remote product colors
            ajax.jsonRpc('/portal/get_product_colors', 'call', {
                    'product_id': g.id
                })
                .then(function (result) {
                    // Show all colors
                    var colorData = result;
                    if (colorData.length > 0) {
                        $("#colorPalette").html("");
                        for (var k in colorData) {
                            var color = colorData[k];
                            var p = $("<span>");
                            p.css("display", "inline-block").css("margin-right", "10px");
                            p.css("width", "30px").css("height", "30px").css("background", color.name);
                            p.attr("data-color", color.name);
                            $("#colorPalette").append(p);
                        }
                        $("#colorPalette").find("span").click(function () {
                            self.setLogoEditorBg($(this).attr("data-color"));
                        });
                        var pid = localStorage.getItem('productId');
                        var cacheColor = localStorage.getItem('productColor');
                        if (cacheColor != null && pid == g.id) {
                            self.setLogoEditorBg(cacheColor);
                        }
                    } else {
                        $("#colorPalette").html("No Color Selected");
                    }
                })
                .fail(function () {
                    var message = _t("Unable to get recent links");
                    self.$el.append("<div class='alert alert-danger'>" + message + "</div>");
                });
        },
        setLogoEditorBg: function (color) {
            if (color != undefined) {
                this.logo_canvas.backgroundImage = 0;
                this.logo_canvas.backgroundColor = color;
                this.logo_canvas.renderAll();
                $(".pan-move-bar").hide("slow");
            }
            // Set background color into cartManager
            this.cartManager.setProductColor(color);
        },
        onDropLogo: function (event) {
            var self = this;
            var logoId = localStorage.getItem("drag-logo-id");
            var cid = $("input[name='decoration_service']:checked").val();
            var logoType = localStorage.getItem("drag-logo-type");
            var dropNode = document.getElementById(logoId).cloneNode(true);
            $(dropNode).removeClass("lslide").removeAttr("style").removeAttr("draggable");
            $(dropNode).addClass("editable-logo");
            //
            var svgString = $(dropNode).html();
            var paths = fabric.loadSVGFromString(svgString, function (objects, options) {
                if (logoType == 0) {
                    objects.map(function (item, index) {
                        item.id = 'logo-' + self.logo_index + "-" + index;
                        item.class = "logo-stroke-path";
                        item.svgUid = index;
                        item.stroke = "#000000";
                        item.dataType = logoType;
                    });
                }
                if (logoType == 1) {
                    objects.map(function (item, index) {
                        item.id = 'logo-' + self.logo_index + "-" + index;
                        item.class = "logo-stroke-path";
                        item.svgUid = index;
                        item.fill = "#000000";
                        item.dataType = logoType;
                    });
                }
                var obj = fabric.util.groupSVGElements(objects, options);
                obj.lockScalingX = true;
                obj.lockScalingY = true;
                obj.inner_paths = [];
                obj.gType = logoType;
                obj.resourceId = logoId;
                obj.cid = cid;
                objects.map(function (item, index) {
                    obj.inner_paths.push(item);
                });
                //obj.subTargetCheck = true;
                //obj.selectable = true;
                obj.scaleToHeight(self.logo_canvas.height / 3)
                    .set({
                        left: self.logo_canvas.width / 2 - 50,
                        top: self.logo_canvas.height / 2 - 50
                    }).center()
                    .setCoords();
                self.logo_canvas.add(obj).renderAll();
                self.showLogoLayers(objects);
                obj.on("selected", function (event) {
                    var act = self.logo_canvas.getActiveObject();
                    self.showLogoLayers(act.inner_paths);
                });
                // Add this logo into cartManager
                self.cartManager.addLogo(obj.svgUid, cid, logoId, logoType);
                self.cartManager.updateLogoPosition(obj.svgUid, obj.left, obj.top);
            });
            var canvas = self.logo_canvas;
            window.fabric.util.addListener(canvas.upperCanvasEl, 'dblclick', function (event) {
                self.removeLogo();
            });
        },
        allowDropLogo: function (event) {
            event.preventDefault();
        },
        showLogoLayers: function (layers) {
            var self = this;
            var clonedLayers = layers.slice(0);
            $("#logoColorLayers").html("");
            while (clonedLayers.length > 0) {
                var colorItems = clonedLayers.splice(0, 3);
                var trEle = $("<tr>");
                for (var key in colorItems) {
                    var layer = colorItems[key];
                    var stroke = layer.strokeData;
                    var inputEle = $('<input style="font-size:0.5em;padding:3px 6px;" type="text" data-path-type="' + layer.dataType + '" data-logo-index="' + layer.id + '" class="form-control" id="layer-' + layer.id + '" placeholder="Step' + layer.svgUid + '" data-key="' + layer.svgUid + '" />');
                    var colorVal = null;
                    if (layer.dataType == 0) {
                        colorVal = layer.strokeData;
                    }
                    if (layer.dataType == 1) {
                        colorVal = layer.fillData;
                    }
                    if (colorVal) {
                        inputEle.attr("value", colorVal);
                    }
                    inputEle.on("focusin", function (event) {
                        event.preventDefault();
                        if (this.value != '') {
                            if (layer.dataType == 0) {
                                self.setPolyLineHighlight($(this).attr("data-logo-index"), this.value);
                            }
                            if (layer.dataType == 1) {
                                self.setPolyLineHighlight($(this).attr("data-logo-index"), this.value);
                            }
                        }
                    });
                    inputEle.on("blur", function (event) {
                        event.preventDefault();
                        if (this.value != '') {
                            if (layer.dataType == 0) {
                                self.setPolyLineNormal($(this).attr("data-logo-index"), layer.dataType, this.value);
                            }
                            if (layer.dataType == 1) {
                                self.setPolyLineNormal($(this).attr("data-logo-index"), layer.dataType, this.value);
                            }
                        }
                    });
                    var tdEle = $("<td>").append(inputEle);
                    trEle.append(tdEle);
                }
                $("#logoColorLayers").append(trEle);
            }
        },
        setPolyLineHighlight: function (id, color) {
            var self = this;
            if (color == '' || color == null || color == undefined) {
                color = "empty";
            }
            color = color.toUpperCase();
            var colorHex = dd[color] || [255, 255, 255];
            var colorData = 'rgb(' + colorHex[0] + ',' + colorHex[1] + ',' + colorHex[2] + ')';
            var currentLogo = this.logo_canvas.getActiveObject();
            if (!currentLogo) return;
            var objects = currentLogo._objects;
            objects.map(function (item) {
                if (item.id == id) {
                    item.set("stroke", colorData);
                    item.set("opacity", 1);
                    item.set("strokeWidth", item.strokeWidth * 2);
                    item.set("dirty", true);
                } else {
                    item.set("opacity", 0.5);
                }
                return item;
            });
            this.logo_canvas.renderAll();
        },
        setPolyLineNormal: function (id, type, color) {
            var self = this;
            if (color == '' || color == null || color == undefined) {
                color = "empty";
            }
            color = color.toUpperCase();
            var colorHex = dd[color] || [0, 0, 0];
            var colorData = 'rgb(' + colorHex[0] + ',' + colorHex[1] + ',' + colorHex[2] + ')';
            var currentLogo = this.logo_canvas.getActiveObject();
            if (!currentLogo) return;
            var objects = currentLogo._objects;
            objects.map(function (item, index) {
                item.set("opacity", 1);
                if (item.id == id) {
                    if (type == 0) {
                        item.set("stroke", colorData);
                        item.set("strokeData", color);
                        item.set("strokeWidth", item.strokeWidth / 2);
                    }
                    if (type == 1) {
                        item.set("fill", colorData);
                        item.set("fillData", color);
                    }
                    self.cartManager.updateLogoStroke(currentLogo.svgUid, item.svgUid, type, color);
                    item.set("dirty", true);
                }
                return item;
            });
            this.logo_canvas.renderAll();
        },
        removeLogo: function () {
            var currentLogo = this.logo_canvas.getActiveObject();
            if (!currentLogo) return;
            this.logo_canvas.remove(currentLogo);
            $("#logoColorLayers").html("<tr><td>No Selected Object</td></tr>");
        }
    });

    /**
     * Author: Shenfei
     * 创建左侧类型Bar
     */
    var CartManager = Widget.extend({
        /**
         * 初始函数
         */
        init: function () {
            this._super();
            this.canvas = null;
            this.productColor = null;
            this.productSizes = [];
            this.viewportTransform = null;
            this.productId = null;
            this.productCategoryId = null;
            this.logoListTable = {};
            this.logoScreenShot = null;
        },
        /**
         * 加载远程Category数据
         */
        start: function () {
            var self = this;
            this.logoListTable = {};
            this.result = {};
            $("#addToCartBtn").removeAttr("disabled");
            $("#addToCartBtn").click(function () {
                if (self.sendValidation()) {
                    return false;
                }
                bootbox.confirm({
                    message: "Do u want to add your design to cart now?",
                    buttons: {
                        confirm: {
                            label: 'Yes',
                            className: 'btn-success'
                        },
                        cancel: {
                            label: 'No',
                            className: 'btn-danger'
                        }
                    },
                    callback: function (result) {
                        if (result) {
                            $.blockUI({
                                css: {
                                    'fontSize': '15px'
                                }
                            });
                            var imageData = null;
                            html2canvas($('#logo-editor'), {
                                onrendered: function (canvas) {
                                    imageData = canvas.toDataURL("image/png");
                                    self.sendResultToServer(imageData);
                                }
                            });
                        }
                    }
                });
                return false;
            });
            // Service surcharges on change event
            $('#service-sc-select').on('changed.bs.select', function () {
                if ($(this).val()) {
                    localStorage.setItem('serviceSurcharges', this.value);
                } else {
                    localStorage.removeItem('serviceSurcharges');
                }
            });

            $('#service-surcharge-qty').on('change', function () {
                if (isNaN(this.value)) {
                    this.value = 0;
                }
                var tmp = Math.abs(this.value);
                if (tmp == "" || tmp == null) {
                    localStorage.removeItem('serviceSurchargeQty');
                } else {
                    localStorage.setItem('serviceSurchargeQty', tmp);
                }
            });
        },
        isEditMode: function () {
            var result = true;
            //var urlParams = new URLSearchParams(window.location.search);
            var id = $.getQueryString('cart_id');
            if (id == null || id == undefined || id.length < 1) {
                result = false;
            }
            return result;
        },
        loadRemoteData: function () {
            var self = this;
            //var urlParams = new URLSearchParams(window.location.search);
            var id = $.getQueryString('cart_id');
            if (id == null || id == undefined || id.length < 1) {
                return false;
            }
            $.blockUI({
                css: {
                    'fontSize': '15px'
                }
            });
            localStorage.setItem("cartId", id);
            var data = new Promise(function (resolve) {
                // Load remote product colors
                ajax.jsonRpc('/portal/get_sale_line', 'call', {
                        'id': id[0]
                    })
                    .then(function (result) {
                        var loadedData = JSON.parse(result);
                        debug(loadedData);
                        if (!$.isEmptyObject(loadedData)) {
                            localStorage.clear();
                            // Set logos
                            localStorage.setItem("logos", loadedData['logos']['data']);
                            // Set product attributes
                            localStorage.setItem('cid', loadedData['product']['categoryId']);
                            localStorage.setItem('productId', loadedData['product']['id']);
                            if (loadedData['product']['color'] != undefined) {
                                localStorage.setItem('productColor', loadedData['product']['color']);
                            }
                            localStorage.setItem('productSizes', loadedData['product']['count']);
                            // Set user operation
                            var ptData = loadedData['op']['product_type'];
                            var tmp = {
                                'data': []
                            };
                            tmp['data'].push(ptData);
                            localStorage.setItem('productType', JSON.stringify(tmp));
                            localStorage.setItem('decorationService', loadedData['op']['decoration_service']);
                            localStorage.setItem('productSource', loadedData['op']['product_source']);
                            // Set service data
                            localStorage.setItem('serviceSurcharges', loadedData['service']['surcharges']);
                            localStorage.setItem('serviceSurchargeQty', loadedData['service']['surcharges_count']);
                        }
                        $.unblockUI();
                    })
                    .fail(function () {
                        var message = _t("Unable to get recent links");
                        self.$el.append("<div class='alert alert-danger'>" + message + "</div>");
                    });
            });
            return data;
        },
        setEditableData: function (data) {

        },
        sendValidation: function () {
            // Data validation BEGIN
            if ($.isEmptyObject(this.logoListTable)) {
                $("#logo-editor").block({
                    message: '<h5>No decoration files found!</h5>',
                    css: {
                        border: '3px solid #a00',
                        width: '70%'
                    },
                    timeout: 3000
                });
                return true;
            }
            // Product count validation
            var productSizes = this.productSizes;
            if (productSizes && productSizes.length > 0) {
                var sizeMaps = productSizes.map(function (item) {
                    return $("#size-" + item.name.toLowerCase() + "-count").val();
                })
                var filterItems = sizeMaps.filter(function (item) {
                    return parseInt(item) > 0;
                })
                if (filterItems.length == 0) {
                    $("#product-sizes-table").block({
                        message: '<h5>Product count empty!</h5>',
                        css: {
                            border: '3px solid #a00',
                            top: 50,
                            width: '90%'
                        },
                        timeout: 3000
                    });
                    return true;
                }
            }
            // Colors Input Complete Validation
            var objs = this.canvas.getObjects();
            var uncompletedObjs = objs.filter(function (item) {
                return (item.editCompleted == undefined || item.editCompleted == false);
            });
            // TODO: uncompletedObjs.length > 0
            if (uncompletedObjs.length == 0) {
                $("#logoColorLayers").block({
                    message: '<h5>Uncompleted color editing!</h5>',
                    css: {
                        border: '3px solid #a00',
                        top: 50,
                        width: '90%'
                    },
                    timeout: 3000
                });
                return true;
            }
            if (this.productId == null) {
                $("#product_types_list").block({
                    message: '<h5>No product type found!</h5>',
                    css: {
                        border: '3px solid #a00'
                    },
                    timeout: 3000
                });
                return true;
            }
            if (this.canvas.backgroundImage == 0) {
                this.canvas.backgroundColor = 'white';
                var canvas = this.canvas;
                canvas.setBackgroundImage("/website/image/product.template/" + this.productId + "/image/500x500", canvas.renderAll.bind(canvas), {
                    left: 50,
                    top: 50,
                    originX: 'left',
                    originY: 'top'
                });
                this.canvas.renderAll();
            }
            return false;
        },
        sendResultToServer: function (screenData) {
            var self = this;
            this.result['screenImage'] = screenData || '';
            this.result['product'] = {};
            this.result['logos'] = {};
            this.result['product']['id'] = this.productId;
            this.result['product']['categoryId'] = this.productCategoryId;
            this.result['product']['color'] = this.productColor;
            this.result['product']['viewportTransform'] = this.viewportTransform;
            // Set product count
            var productSizes = this.productSizes;
            if (productSizes && productSizes.length > 0) {
                var sizeObjs = {};
                var sizeMaps = productSizes.map(function (item) {
                    var count = parseInt($("#size-" + item.name.toLowerCase() + "-count").val());
                    if (count > 0) {
                        sizeObjs[item.name.toLowerCase()] = count;
                    }
                    return item;
                })
                this.result['product']['count'] = JSON.stringify(sizeObjs);
            }
            // Filter AI Files
            var objs = this.canvas.getObjects();
            var aiObjs = objs.filter(function (item) {
                return item.gType == '1';
            });
            var aiSvgData = [];
            if (aiObjs.length > 0) {
                aiSvgData = aiObjs.map(function (item) {
                    var _tmp = new fabric.Canvas('tmp');
                    _tmp.add(item);
                    var svgTmp = _tmp.toSVG();
                    self.exportLogoToSvg(item.svgUid, svgTmp);
                    return item;
                })
            }
            this.result['logos']['data'] = JSON.stringify(self.logoListTable);
            // Set Service surcharges
            var serviceSc = $("#service-sc-select").val();
            var serviceScCount = $("#service-surcharge-qty").val();
            this.result['service'] = {};
            this.result['service']['surcharges'] = serviceSc;
            this.result['service']['surcharges_count'] = serviceScCount;
            this.result['op'] = {};
            var ds = $("input[name='decoration_service']:checked").val();
            this.result['op']['decoration_service'] = ds;
            var ps = $("input[name='product_source']:checked").val();
            this.result['op']['product_source'] = ds;
            var pt = $("input[name='product_type']:checked").val();
            this.result['op']['product_type'] = pt;
            // Check edit or create action
            if (this.isEditMode()) {
                //var urlParams = new URLSearchParams(window.location.search);
                var id = $.getQueryString('cart_id');
                this.result['sale_line'] = {};
                this.result['sale_line']['id'] = id;
            }
            ajax.jsonRpc("/portal/add_to_cart", 'call', this.result).then(function (apiResult) {
                $.unblockUI();
                if (apiResult.error) {
                    $.growlUI('Failure', apiResult);
                } else {
                    delete self.result['screenImage'];
                    $.growlUI('Success', 'Item is added successfully.');
                    var localData = JSON.stringify(self.result);
                    var saleLineId = apiResult.sale_order_line_id;
                    if (saleLineId != undefined) {
                        self.saveLocalData(saleLineId, localData);
                    }
                }
            });
        },
        saveLocalData: function (id, localData) {
            localStorage.setItem('lastSavedId', id);
            localStorage.setItem('sale-line-' + id, localData);
        },
        enableAddToCart: function () {
            var completed = true;
            for (var key in this.logoListTable) {
                var logo = this.logoListTable[key];
                if (logo['editCompleted'] != true) {
                    completed = false;
                    break;
                }
            }
            return completed;
        },
        setProductId: function (cid, id) {
            this.productCategoryId = cid;
            this.productId = id;
            this.productColor = null;
            localStorage.setItem('cid', cid);
            localStorage.setItem('productId', this.productId);
            localStorage.removeItem("productColor");
        },
        setProductColor: function (color) {
            this.productColor = color;
            localStorage.setItem('productColor', color);
        },
        setProductSizes: function (sizes) {
            this.productSizes = sizes;
        },
        updateProductSizes: function () {
            var productSizes = this.productSizes;
            if (productSizes && productSizes.length > 0) {
                var sizeObjs = {};
                var sizeMaps = productSizes.map(function (item) {
                    var count = parseInt($("#size-" + item.name.toLowerCase() + "-count").val());
                    if (count > 0) {
                        sizeObjs[item.name.toLowerCase()] = count;
                    }
                    return item;
                })
                localStorage.setItem('productSizes', JSON.stringify(sizeObjs));
            }
        },
        getLogoBysvgUid: function (logoId) {
            var cachedLogoData = localStorage.getItem('logos');
            if (cachedLogoData != null) {
                var cachedLogo = JSON.parse(cachedLogoData);
                if (cachedLogo['svgUid'] == logoId) {
                    return cachedLogo;
                }
            }
            if (typeof this.logoListTable[logoId] == 'undefined') {
                var newLogoObj = {};
                newLogoObj['svgUid'] = logoId;
                newLogoObj['editCompleted'] = false;
                this.logoListTable[logoId] = newLogoObj;
            }
            return this.logoListTable[logoId];
        },
        addLogo: function (logoId, cid, resourceId, logoType) {
            var logoObj = this.getLogoBysvgUid(logoId);
            logoObj['resourceId'] = resourceId;
            logoObj['cid'] = cid,
            logoObj['type'] = logoType;
            localStorage.setItem('logos', JSON.stringify(this.logoListTable));
        },
        removeLogo: function (logoId) {
            delete this.logoListTable[logoId];
            localStorage.setItem('logos', JSON.stringify(this.logoListTable));
        },
        setLogoPathsCount: function (logoId, count) {
            var logoObj = this.getLogoBysvgUid(logoId);
            logoObj['pathsCount'] = count;
            logoObj = this.getLogoBysvgUid(logoId);
        },
        updateLogoPosition: function (logoId, left, top) {
            var logoObj = this.getLogoBysvgUid(logoId);
            logoObj['top'] = top;
            logoObj['left'] = left;
            logoObj = this.getLogoBysvgUid(logoId);
            localStorage.setItem('logos', JSON.stringify(this.logoListTable));
        },
        setCanvasViewportTransform: function (vpt) {
            this.viewportTransform = vpt;
            localStorage.setItem('viewportTransform', this.viewportTransform);
        },
        setLogoType: function (logoId, type) {
            var logoObj = this.getLogoBysvgUid(logoId);
            logoObj['type'] = type;
        },
        updateLogoStroke: function (logoId, itemOrder, type, color) {
            var logoObj = this.getLogoBysvgUid(logoId);
            var key = 'paths';
            if (type == 1) {
                key = 'fill'
            }
            if (typeof logoObj[key] == 'undefined') {
                logoObj[key] = {};
            }
            var paths = logoObj[key];
            paths[itemOrder] = color;
            var keys = Object.keys(paths);
            if (keys.length == logoObj['pathsCount']) {
                logoObj['editCompleted'] = true;
            }
            localStorage.setItem('logos', JSON.stringify(this.logoListTable));
        },
        exportLogoToSvg: function (logoId, data) {
            var logoObj = this.getLogoBysvgUid(logoId);
            logoObj['imageData'] = data;
        },
        setLogoScreenShot: function (data) {
            this.logoScreenShot = data;
            // Save screenshot
            html2canvas($('#logo-editor'), {
                onrendered: function (canvas) {
                    var imageData = canvas.toDataURL("image/png");
                }
            });
        },
        getJsonData: function () {
            return JSON.stringify('');
        },
        setCanvas: function (c) {
            this.canvas = c;
        }
    });

    /**
     * 加载Category数据模板
     */
    ajax.loadXML('/emb_portal/static/src/xml/logo_edit.xml', qweb);

    /**
     * 等待页面加载完成后，加载数据
     */
    base.ready().done(function () {
        //localStorage.clear();
        // 添加操作条到右侧操作栏
        $("#logo-edit-bar").append(qweb.render('emb_portal.GarmentColorPanel'));
        $("#logo-edit-bar").append(qweb.render('emb_portal.GarmentCountPanel'));
        $("#logo-edit-bar").append(qweb.render('emb_portal.LogoLayersPanel'));
        $("#logo-edit-bar").append(qweb.render('emb_portal.AddToCart'));
        var cartManager = new CartManager();
        var logoUpload, logoEditor, garmentManager, categoryWidget;
        if (cartManager.isEditMode()) {
            cartManager.loadRemoteData();
        }
        cartManager.start();
        logoUpload = new LogoUpload(cartManager);
        logoUpload.start();
        logoEditor = new LogoEditor(cartManager, logoUpload);
        logoEditor.start();
        garmentManager = new GarmentListManager(logoEditor, cartManager);
        garmentManager.start()
        categoryWidget = new ProductCatetoryList(logoUpload, garmentManager);
        categoryWidget.start();
    });

    exports.LogoEditor = LogoEditor;

    return exports;
});